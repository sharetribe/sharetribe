- content_for :title_header do
  %h1
    = t("layouts.admin.admin")
    = "-"
    = t(".title")

- if local_assigns[:show_onboarding_popup]
  = render :layout => "layouts/lightbox", :partial => "layouts/onboarding_popup", locals: {title: t(popup_title_key), body: t(popup_body_key), action_label: t(popup_button_key), action_link: popup_action_link, image: asset_path(popup_image), id: "onboarding-popup" }

= render :partial => "admin/left_hand_navigation", :locals => { :links => admin_links_for(@current_community) }

.left-navi-section.payment-settings

  .row.paypal-wizard.no-border
    .col-12
      = render partial: 'general_prefs_form', locals: {payment_prefs_form: payment_prefs_form, payment_prefs_valid: payment_prefs_valid, currency: currency, available_currencies: available_currencies, support_email: support_email, payments_connected: stripe_connected || paypal_connected, country_name: country_name}

    .paypal-wizard-content
      .row
        .col-12
          %h2
            = t("admin.payment_preferences.connect_a_payment_provider")
          - if !stripe_allowed && !paypal_allowed
            - support_link = link_to t("admin.payment_preferences.contact_support"), "mailto:#{support_email}"
            - help_link = link_to t("admin.payment_preferences.no_payments_link_text"), "#{knowledge_base_url}/supported-payments-currencies"
            = t("admin.payment_preferences.you_cannot_use_online_payments", currency: @current_community.currency, country_name: country_name, support_link: support_link, help_link: help_link).html_safe
          - else

            - if stripe_allowed && paypal_allowed
              - popup_link = link_to t("admin.payment_preferences.which_to_choose"), "#", id: "choose_payment_popup_link"
              = t("admin.payment_preferences.you_can_use_stripe_or_paypal", choose_link: popup_link).html_safe

              = render layout: "layouts/lightbox", locals: { id: "payment_choose_popup_content"} do
                - text_with_line_breaks_html_safe do
                  = t("admin.payment_preferences.choose_popup_text")
                - help_url = "#{knowledge_base_url}/payment-with-paypal-and-stripe/guide-to-getting-started-with-payments"
                = link_to t("admin.payment_preferences.read_more_about_paypal_and_stripe"), help_url,  target: "_blank"

              - content_for :extra_javascript do
                :javascript
                  $('#choose_payment_popup_link').click(function() { $('#payment_choose_popup_content').lightbox_me({centered: true, zIndex: 1000000}); });

            .row.connect-row
              - if stripe_enabled && stripe_allowed
                - if stripe_connected
                  .col-6
                    %h3.paypal-account-connected
                      =icon_tag("check", ["icon-fix"])
                      =t("admin.payment_preferences.stripe_connected.title")
                    = link_to t("admin.payment_preferences.change_settings"), "#", id: "config_stripe_toggle"
                - else
                  .col-6
                    = link_to t("admin.payment_preferences.configure_stripe"), "#", class: "button", id: "config_stripe_toggle"

              - if paypal_enabled && paypal_allowed
                - if paypal_connected
                  .col-6
                    %h3.paypal-account-connected
                      =icon_tag("check", ["icon-fix"])
                      =t("admin.payment_preferences.paypal_connected.title")
                    = link_to t("admin.payment_preferences.change_settings"), "#", id: "config_paypal_toggle"
                - else
                  .col-6
                    = link_to t("admin.payment_preferences.configure_paypal"), "#", class: "button", id: "config_paypal_toggle"


    .col-12.payment-tabs.hidden.no-float
      .tabs-list
        - if stripe_enabled && stripe_allowed
          = link_to "Stripe", "#", data: {tab: 'stripe_tab'}, class: "tab-link stripe"
        - if paypal_enabled && paypal_allowed
          = link_to "PayPal", "#", data: {tab: 'paypal_tab'}, class: "tab-link paypal"

      - if stripe_enabled && stripe_allowed
        .tab-content.hidden#stripe_tab
          - if !stripe_account[:api_verified]
            - stripe_keys_link = "#{knowledge_base_url}/how-to-get-stripe-api-keys"
            = render partial: 'stripe_form', locals: {stripe_account: stripe_account, stripe_api_form: stripe_api_form, stripe_keys_link: stripe_keys_link}
          - else
            = render partial: 'stripe_connected', locals: {stripe_account: stripe_account}
            .paypal-wizard-divider
            = render partial: 'prefs_form', locals: {payment_prefs_form: stripe_prefs_form, currency: currency, available_currencies: available_currencies, support_email: support_email, pref_mode: 'stripe'}

      - if paypal_enabled && paypal_allowed
        .tab-content.hidden#paypal_tab
          - if !paypal_account.present?
            = render partial: 'paypal_connect_account', locals: {order_permission_action: order_permission_action}
          - else
            = render partial: 'paypal_connected', locals: {paypal_account: paypal_account, order_permission_action: order_permission_action}
            .paypal-wizard-divider
            = render partial: 'prefs_form', locals: {payment_prefs_form: paypal_prefs_form, currency: currency, available_currencies: available_currencies, support_email: support_email, pref_mode: 'paypal'}
    
    - if paypal_ready && stripe_ready
      = render partial: 'paypal_connect_own_notice', locals: {connected_mode: 'stripe_and_paypal'}
    - elsif stripe_ready
      = render partial: 'paypal_connect_own_notice', locals: {connected_mode: 'stripe_only'}
    - elsif paypal_ready
      = render partial: 'paypal_connect_own_notice', locals: {connected_mode: 'paypal_only'}

    - content_for :extra_javascript do
      :javascript
        window.ST.initPaymentTabs(#{payment_prefs_form.minimum_listing_price.to_f}, "#{t("admin.payment_preferences.fee_should_be_less_than_minimum_price")}")

    - if stripe_enabled && stripe_allowed && stripe_account[:api_verified] && !stripe_ready
      - content_for :extra_javascript do
        :javascript
          $('#config_stripe_toggle').click();
    - elsif paypal_enabled && paypal_allowed && paypal_account.present? && !paypal_ready
      - content_for :extra_javascript do
        :javascript
          $('#config_paypal_toggle').click();
 
